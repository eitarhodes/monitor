<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Monitor Master 2026 V139</title>
    <!-- Firebase SDK (Modular v11.6.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.fb = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, onSnapshot, collection };
    </script>

    <style>
        :root { 
            --blue: #2563eb; 
            --orange: #f59e0b; 
            --red: #ef4444;    
            --purple: #a855f7; 
            --emerald: #10b981; 
            --slate: #475569; 
            --bg: #f1f5f9; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); padding-bottom: 140px; color: #0f172a; 
            overflow-x: hidden; line-height: 1.4;
        }
        
        .status-bar { 
            position: sticky; top: 0; z-index: 1000; 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px 16px; font-size: 10px; font-weight: 800; border-bottom: 1px solid #e2e8f0; 
        }

        .container { width: 100%; max-width: 768px; margin: 0 auto; padding: 10px; }
        
        .header { background: white; border-radius: 24px; padding: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); margin-bottom: 10px; text-align: left; position: relative; }
        .clock { font-family: monospace; font-size: clamp(24px, 5vw, 32px); font-weight: 900; font-style: italic; letter-spacing: -1px; color: #1e293b; }
        
        /* „Éê„Éº„Ç∏„Éß„É≥ ÔºÜ Êé®Â•®„Éñ„É©„Ç¶„Ç∂ */
        .ver-info { position: absolute; top: 12px; left: 60px; display: flex; align-items: center; gap: 6px; }
        .ver-badge { background: #e2e8f0; color: #64748b; font-size: 8px; padding: 1px 6px; border-radius: 4px; font-weight: 900; }
        .browser-badge { background: #fef3c7; color: #b45309; font-size: 8px; padding: 1px 6px; border-radius: 4px; font-weight: 900; border: 1px solid #fde68a; }

        .voice-section { display: flex; gap: 8px; margin-top: 12px; }
        .btn-voice-main { flex: 3; padding: 14px; border-radius: 16px; border: none; font-weight: 900; font-size: 12px; cursor: pointer; transition: 0.1s; color: white; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-blue { background: var(--blue); border-bottom: 4px solid #1e40af; }
        .btn-purple { background: var(--purple); border-bottom: 4px solid #7e22ce; }
        .btn-voice-main:active { transform: translateY(2px); border-bottom-width: 2px; }
        .btn-test { flex: 1; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 16px; font-weight: 800; font-size: 10px; color: #64748b; cursor: pointer; }

        /* „Ç´„Éº„Éâ„Éá„Ç∂„Ç§„É≥ */
        .card { background: white; border-radius: 22px; padding: clamp(10px, 2.5vw, 16px); border: 2px solid #e2e8f0; margin-bottom: 8px; position: relative; overflow: hidden; transition: 0.3s; }
        .card.caution { border-color: var(--orange); background: #fffbeb; }
        .card.urgent { border-color: var(--red); background: #fff1f2; }
        .card.finished { border-color: var(--purple); background: #faf5ff; }
        .card.cancelled { border-color: #94a3b8; background: #f8fafc; opacity: 0.7; }
        
        .btn-hide-ev {
            position: absolute; top: 0; right: 0; width: 36px; height: 36px;
            background: #e2e8f0; color: var(--slate); border: none; border-bottom-left-radius: 12px;
            font-size: 18px; font-weight: 900; cursor: pointer; z-index: 50;
            display: flex; align-items: center; justify-content: center;
        }

        .status-badge-large {
            position: absolute; top: 40px; right: 10px;
            color: white; padding: 4px 14px; border-radius: 10px;
            font-size: 16px; font-weight: 900;
            z-index: 10; transform: rotate(2deg); border: 2px solid white;
        }
        .finish-badge { background: var(--orange); box-shadow: 0 4px 10px rgba(245, 158, 11, 0.4); }
        .cancel-badge { background: #1e293b; top: 15px; }

        .tag-badge {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 2px 8px; border-radius: 6px;
            font-size: 10px; font-weight: 900; color: white;
            min-width: 50px; height: 20px; line-height: 1;
            letter-spacing: 0.5px; margin-right: 4px;
        }
        .tag-large-scale { background: var(--red); }
        .tag-sold-out { background: var(--emerald); }

        .flex { display: flex; align-items: center; gap: 8px; }
        .between { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }
        
        .venue-name { font-size: clamp(16px, 4vw, 17px); font-weight: 900; text-decoration: underline; color: var(--blue); cursor: pointer; text-align: left; }
        .capa-badge { background: #f1f5f9; padding: 2px 6px; border-radius: 6px; font-size: 10px; font-weight: 800; font-family: monospace; }
        
        .time-area { flex-shrink: 0; text-align: right; display: flex; flex-direction: column; gap: 4px; align-items: flex-end; margin-left: auto; }
        .horizontal-box { padding: 4px 10px; border-radius: 10px; display: flex; align-items: baseline; gap: 6px; }
        .time-box-horizontal { background: #f8fafc; border: 1.5px solid #e2e8f0; }
        .large-time { font-size: 20px; font-weight: 900; font-family: monospace; line-height: 1; }
        .predicted-time-text { font-size: 19px; font-weight: 900; color: var(--blue); line-height: 1; font-family: serif; }
        
        .event-title { 
            font-size: 16px; font-weight: 800; color: #334155; margin-top: 6px; 
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; border-top: 1px solid #f1f5f9; padding-top: 6px; text-align: left;
        }
        .expand-content { max-height: 0; opacity: 0; overflow: hidden; transition: 0.3s ease; }
        .expand-content.open { max-height: 80px; opacity: 1; padding-top: 8px; }

        .gauge-container { margin-top: 8px; position: relative; padding-bottom: 14px; }
        .gauge-bar { height: 6px; background: #e2e8f0; border-radius: 10px; overflow: hidden; position: relative; }
        .gauge-fill { height: 100%; transition: width 1s linear; }
        .gauge-markers { position: absolute; width: 100%; top: 9px; left: 0; display: flex; justify-content: space-between; padding: 0 2px; }
        .marker { display: flex; flex-direction: column; align-items: center; width: 0; position: absolute; transform: translateX(-50%); }
        .marker-dot { width: 3px; height: 3px; background: #cbd5e1; border-radius: 50%; margin-bottom: 2px; }
        .marker-label { font-size: 8px; font-weight: 900; color: #94a3b8; white-space: nowrap; opacity: 0.5; }
        .marker.active .marker-dot { background: var(--active-color); }
        .marker.active .marker-label { color: var(--active-color); opacity: 1; }

        .scroll-nav { position: fixed; right: 12px; bottom: 90px; display: flex; flex-direction: column; gap: 10px; z-index: 1500; }
        .scroll-btn { width: 42px; height: 42px; border-radius: 50%; background: rgba(255,255,255,0.4); backdrop-filter: blur(4px); border: 1px solid #cbd5e1; color: #94a3b8; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.08); cursor: pointer; }

        .modal { position: fixed; inset: 0; z-index: 2000; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; border-radius: 32px; padding: 24px; width: 100%; max-width: 480px; text-align: center; }
        .pass-input { width: 100%; text-align: center; font-size: 32px; letter-spacing: 10px; padding: 12px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 16px; margin-bottom: 20px; outline: none; }
        .hidden { display: none !important; }
        
        .sync-loading { padding: 80px 0; text-align: center; color: var(--slate); font-weight: 900; letter-spacing: 2px; font-size: 14px; }
    </style>
</head>
<body>

    <div class="status-bar">
        <div class="flex"><span id="sync-icon" style="color:#f59e0b">‚óè</span><span id="sync-label">CONNECTING...</span></div>
        <div class="flex">
            <span style="font-size: 9px; color: #94a3b8; margin-right:8px;">V139 STABLE</span>
            <span id="jst-date-label" style="background:var(--slate); color:white; padding:2px 8px; border-radius:6px; font-family:monospace;">----</span>
        </div>
    </div>

    <div class="scroll-nav">
        <button class="scroll-btn" onclick="window.scrollTo({top:0, behavior:'smooth'})"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m18 15-6-6-6 6"/></svg></button>
        <button class="scroll-btn" onclick="window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'})"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m6 9 6 6 6-6"/></svg></button>
    </div>

    <div class="container">
        <div class="header">
            <div class="ver-info">
                <div class="ver-badge">VER 1.39</div>
                <div class="browser-badge">Êé®Â•®: Safari / Chrome</div>
            </div>
            <div class="between" style="margin-bottom:12px; text-align: left;">
                <div class="flex">
                    <div style="background:var(--blue); color:white; padding:8px; border-radius:12px; display:flex;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg></div>
                    <div style="line-height:1.1">
                        <div id="ui-date" style="font-weight:900; font-size:14px;">----/--/--</div>
                        <div style="font-size:8px; opacity:0.3; text-transform:uppercase;">Monitor Master 2026</div>
                    </div>
                </div>
                <div id="clock" class="clock">00:00:00</div>
            </div>
            <div class="voice-section">
                <button id="voice-btn" class="btn-voice-main btn-blue" onclick="window.toggleAudio()"><span>üîà Èü≥Â£∞ÈÄöÁü•„ÇíÊúâÂäπ„Å´„Åô„Çã</span></button>
                <button id="test-btn" class="btn-test hidden" onclick="window.runVoiceTest()"><span>üì¢ Ë©¶ËÅ¥</span></button>
            </div>
        </div>

        <div id="list-container"><div class="sync-loading">üîÑ „ÇØ„É©„Ç¶„Éâ„Åã„ÇâÂêåÊúü‰∏≠...</div></div>

        <div style="margin-top:40px; text-align:center;">
            <div style="margin-bottom:20px;">
                <button onclick="window.toggleHistoryUI()" id="history-btn" style="background:none; border:none; color:#94a3b8; font-size:11px; font-weight:bold; text-decoration:underline;">ÁµÇ‰∫ÜÂ±•Ê≠¥„ÇíË°®Á§∫</button>
                <div id="history-list" class="hidden w-full space-y-2 mt-4 text-left"></div>
            </div>
            <button onclick="window.openAdmin()" style="margin-top:80px; opacity:0.1; background:none; border:none; font-size:8px; font-weight:bold; letter-spacing:2px;">ADMIN PANEL</button>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´ -->
    <div id="modal-pass" class="modal"><div class="modal-content"><h3 style="margin:0 0 15px 0; font-weight:900;">ADMIN PIN</h3><input type="password" id="pin" class="pass-input" maxlength="4" inputmode="numeric" placeholder="****"><div class="flex"><button onclick="window.closeModals()" style="flex:1; border:none; background:none; font-weight:bold; color:#94a3b8;">Êàª„Çã</button><button onclick="window.verifyAdmin()" style="flex:1.5; background:var(--blue); color:white; border:none; padding:12px; border-radius:12px; font-weight:bold;">Ë™çË®º</button></div></div></div>
    <div id="modal-admin" class="modal"><div class="modal-content text-left"><h3 style="margin:0 0 10px 0; font-weight:900;">JSON Import</h3><textarea id="json-input" style="width:100%; font-family:monospace; font-size:10px; border-radius:16px; border:1px solid #ddd; padding:12px;" rows="8" placeholder="[...]"></textarea><button id="import-btn" class="btn-voice-main btn-blue" style="margin-top:10px; width: 100%;" onclick="window.doImport()">ÂèçÊò†</button></div></div>
    
    <audio id="se-chime" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
    <audio id="se-loop" src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=" loop></audio>

    <script type="module">
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mm-2026-v137';
        const apiKey = ""; 
        const PIN = "2026";

        let state = {
            evs: [],
            hidden: new Set(),
            restored: new Set(),
            ex: new Set(),
            audio: false,
            authed: false,
            notified: new Set(),
            isSpeaking: false,
            db: null,
            auth: null,
            receivedInitialData: false
        };

        function getJST() {
            const now = new Date();
            const jstTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (9 * 3600000));
            const y = jstTime.getFullYear();
            const m = String(jstTime.getMonth() + 1).padStart(2, '0');
            const d = String(jstTime.getDate()).padStart(2, '0');
            return { stamp: `${y}${m}${d}`, display: `${y}/${m}/${d}` };
        }

        function getPronunciation(text) { return text.replace(/Ê§øÂ±±Ëçò/g, '„ÉÅ„É≥„Ç∂„É≥„ÇΩ„Ç¶').replace(/[üè®üìç]/g, '').replace(/„Éõ„ÉÜ„É´„Ç∂„Éª/g, ''); }
        
        window.openMap = (loc) => { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc.split('@')[0])}`, '_blank'); };

        function refreshUI() {
            const jst = getJST();
            const now = new Date();
            const clockEl = document.getElementById('clock');
            if(clockEl) clockEl.innerText = now.toLocaleTimeString('ja-JP',{hour12:false});
            document.getElementById('ui-date').innerText = jst.display;
            document.getElementById('jst-date-label').innerText = jst.stamp;

            if(!state.receivedInitialData) return;

            const data = state.evs.filter(e => e.date === jst.stamp).map(e => {
                const [h, m] = e.end.split(':').map(Number);
                const t = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0);
                return { ...e, diff: Math.floor((t - now) / 60000) };
            });

            const main = data.filter(e => state.restored.has(e.id) || (!state.hidden.has(e.id) && e.diff > -66)).sort((a,b) => a.diff - b.diff);
            const hist = data.filter(e => !state.restored.has(e.id) && (state.hidden.has(e.id) || e.diff <= -66)).sort((a,b) => b.diff - a.diff);

            const listEl = document.getElementById('list-container');
            if(!main.length) {
                listEl.innerHTML = `<div style="padding:60px 0; text-align:center; opacity:0.2; font-weight:900; font-size:12px;">NO ACTIVE EVENTS</div>`;
            } else {
                listEl.innerHTML = main.map((e, idx) => {
                    const isF = e.diff <= 0, isC = e.cancelled === true;
                    const urgent = e.diff <= 10 && !isF, caution = e.diff <= 30 && !urgent && !isF;
                    const cardClass = isC ? 'cancelled' : isF ? 'finished' : urgent ? 'urgent' : caution ? 'caution' : '';
                    const color = isC ? '#94a3b8' : isF ? 'var(--purple)' : urgent ? 'var(--red)' : caution ? 'var(--orange)' : 'var(--blue)';
                    const fill = isF ? Math.min(100, (Math.abs(e.diff)/65)*100) : Math.max(0, 100-(e.diff/60)*100);
                    const isSoldOut = e.name.includes('ÂÆåÂ£≤') || e.soldOut === true;

                    return `
                    <div class="card ${cardClass}">
                        ${isC ? `<div class="status-badge-large cancel-badge">‰∏≠Ê≠¢</div>` : (isF ? `<div class="status-badge-large finish-badge">ÁµÇÊºî</div>` : '')}
                        <button class="btn-hide-ev" onclick="window.hideEvent(${e.id})">‚úï</button>
                        <div class="between">
                            <div style="flex:1; min-width:180px;">
                                <div class="flex" style="margin-bottom:2px;">
                                    <span style="font-size:10px; font-weight:900; opacity:0.2;">${idx+1}</span>
                                    <span class="venue-name" onclick="window.openMap('${e.location}')">üìç${e.location.split('@')[0].replace(/[üè®üìç]/g,'')}</span>
                                </div>
                                <div class="flex" style="flex-wrap: wrap; gap: 4px;">
                                    <span class="capa-badge">CAPA ${e.capa}</span>
                                    ${(parseInt(e.capa.toString().replace(/,/g,'')) >= 8000) ? '<span class="tag-badge tag-large-scale">Â§ßË¶èÊ®°</span>' : ''}
                                    ${isSoldOut ? '<span class="tag-badge tag-sold-out">ÂÆåÂ£≤</span>' : ''}
                                </div>
                            </div>
                            <div class="time-area">
                                ${!isF && !isC ? `
                                    <div class="horizontal-box time-box-horizontal" style="border-color:${color}">
                                        <span class="label-small">ÊÆã„Çä</span>
                                        <div class="large-time" style="color:${color}">${e.diff}<small style="font-size:10px; font-weight:900;">ÂàÜ</small></div>
                                    </div>
                                    <div class="predicted-time-text">${e.end}</div>
                                ` : isC ? `<div class="large-time" style="color:#64748b; font-size:20px;">‰∏≠Ê≠¢</div>` : `
                                    <div style="background:#f3e8ff; border:1.5px solid #d8b4fe; padding:4px 10px; border-radius:12px; text-align:center;">
                                        <div class="large-time" style="color:var(--purple); font-size:20px;">${e.end}</div>
                                        <div style="font-size:9px; font-weight:bold; color:var(--purple); opacity:0.7;">${Math.abs(e.diff)}ÂàÜÁµåÈÅé</div>
                                    </div>
                                `}
                            </div>
                        </div>
                        <div onclick="window.toggleEx(${e.id})" class="event-title"><span>${e.name}</span><span>${state.ex.has(e.id)?'‚ñ≤':'‚ñº'}</span></div>
                        <div class="expand-content ${state.ex.has(e.id)?'open':''}">
                            <button onclick="window.open('${e.url}','_blank')" style="width:100%; padding:10px; background:var(--slate); color:white; border:none; border-radius:14px; font-size:10px; font-weight:900;">DETAILS</button>
                        </div>
                        <div class="gauge-container" style="--active-color: ${color}">
                            <div class="gauge-bar"><div class="gauge-fill" style="width:${fill}%; background:${color}; ${isF ? 'float:right;' : ''}"></div></div>
                            <div class="gauge-markers">
                                ${[0, 25, 50, 75, 100].map((pos, i) => {
                                    const labels = isF ? ['ÁµÇÊºî', '15ÂàÜ', '30', '45', '65ÂàÜ'] : ['60ÂàÜ', '45', '30', '15', 'ÁµÇÊºî'];
                                    return `<div class="marker ${(isF ? (fill >= (100 - pos)) : (fill >= pos)) ? 'active' : ''}" style="left:${pos}%"><div class="marker-dot"></div><div class="marker-label">${labels[i]}</div></div>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }

            const histEl = document.getElementById('history-list');
            histEl.innerHTML = hist.map(e => `
                <div class="flex items-center justify-between p-3 rounded-2xl border border-slate-200 opacity-60 bg-white shadow-sm mb-2 text-left">
                    <div class="flex-1 italic font-black text-[13px]">üìç ${e.location.split('@')[0].replace(/[üè®üìç]/g,'')} (${e.end} ÁµÇ‰∫Ü)</div>
                    <button onclick="window.restoreEvent(${e.id})" class="ml-4 px-4 py-1.5 bg-slate-200 text-slate-800 rounded-xl font-black text-[10px]">‚Ü©Ô∏è Âæ©ÂÖÉ</button>
                </div>
            `).join('') || `<div class="text-center py-4 opacity-20 font-bold text-xs italic tracking-widest">NO HISTORY</div>`;

            if(state.audio && state.authed && !state.isSpeaking) {
                [30, 10].forEach(t => {
                    const targets = main.filter(e => e.diff === t && !e.cancelled && !state.notified.has(e.id + '_' + t));
                    if(targets.length > 0) {
                        document.getElementById('se-chime').play().catch(()=>{});
                        window.speak(`${targets.map(e => getPronunciation(e.location.split('@')[0])).join('„ÄÅ')}„ÄÅ${t}ÂàÜÂâç„Åß„Åô`);
                        targets.forEach(e => state.notified.add(e.id + '_' + t));
                    }
                });
            }
        }

        async function init() {
            const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            if(!config) return;
            const app = window.fb.initializeApp(config);
            state.auth = window.fb.getAuth(app);
            state.db = window.fb.getFirestore(app);

            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await window.fb.signInWithCustomToken(state.auth, __initial_auth_token);
                } else {
                    await window.fb.signInAnonymously(state.auth);
                }
            };
            await initAuth();

            window.fb.onAuthStateChanged(state.auth, (user) => {
                if(user) {
                    state.authed = true;
                    document.getElementById('sync-icon').style.color = '#22c55e';
                    document.getElementById('sync-label').innerText = 'ONLINE';
                    window.fb.onSnapshot(window.fb.doc(state.db, 'artifacts', appId, 'public', 'data', 'daily_events', getJST().stamp), (s) => {
                        state.receivedInitialData = true;
                        if(s.exists()) { state.evs = s.data().list || []; }
                        else { state.evs = []; }
                        refreshUI();
                    }, (err) => { 
                        console.error(err); 
                        document.getElementById('list-container').innerHTML = `<div class="sync-loading">SYNC ERROR: ${err.code}</div>`;
                    });
                }
            });
        }

        window.toggleAudio = () => {
            state.audio = !state.audio;
            const b = document.getElementById('voice-btn');
            b.innerText = state.audio ? "‚úÖ Èü≥Â£∞ÈÄöÁü•Á®ºÂÉç‰∏≠" : "üîà Èü≥Â£∞ÈÄöÁü•„ÇíÊúâÂäπ„Å´„Åô„Çã";
            b.className = state.audio ? "btn-voice-main btn-purple" : "btn-voice-main btn-blue";
            if(state.audio) { document.getElementById('se-loop').play().catch(()=>{}); window.speak("Áõ£Ë¶ñ„ÇíÈñãÂßã„Åó„Åæ„Åô"); document.getElementById('test-btn').classList.remove('hidden'); }
            else { document.getElementById('se-loop').pause(); document.getElementById('test-btn').classList.add('hidden'); }
        };

        window.speak = async (text) => {
            if(!state.audio) return;
            state.isSpeaking = true;
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } } })
                });
                const res = await r.json();
                const pcm = res.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if(pcm) {
                    const b = atob(pcm), len = b.length, buf = new ArrayBuffer(44 + len), v = new DataView(buf);
                    const ws = (o, s) => { for (let i = 0; i < s.length; i++) v.setUint8(o + i, s.charCodeAt(i)); };
                    ws(0, 'RIFF'); v.setUint32(4, 36 + len, true); ws(8, 'WAVE'); ws(12, 'fmt ');
                    v.setUint32(16, 16, true); v.setUint16(20, 1, true); v.setUint16(22, 1, true); v.setUint32(24, 24000, true);
                    v.setUint32(28, 48000, true); v.setUint16(32, 2, true); v.setUint16(34, 16, true); ws(36, 'data'); v.setUint32(40, len, true);
                    for (let i = 0, o = 44; i < len; i++) v.setUint8(o + i, b.charCodeAt(i));
                    const audio = new Audio(URL.createObjectURL(new Blob([buf], { type: 'audio/wav' })));
                    audio.onended = () => state.isSpeaking = false;
                    audio.play();
                } else state.isSpeaking = false;
            } catch { state.isSpeaking = false; }
        };

        window.runVoiceTest = () => window.speak("Ê≠£Â∏∏„Å´Âãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ");
        window.hideEvent = (id) => { state.hidden.add(id); state.restored.delete(id); refreshUI(); };
        window.restoreEvent = (id) => { state.restored.add(id); state.hidden.delete(id); refreshUI(); };
        window.toggleEx = (id) => { state.ex.has(id) ? state.ex.delete(id) : state.ex.add(id); refreshUI(); };
        window.toggleHistoryUI = () => { const h = document.getElementById('history-list').classList.toggle('hidden'); document.getElementById('history-btn').innerText = h ? "ÁµÇ‰∫ÜÂ±•Ê≠¥„ÇíË°®Á§∫" : "Â±•Ê≠¥„ÇíÈñâ„Åò„Çã"; };
        window.openAdmin = () => { document.getElementById('modal-pass').style.display='flex'; };
        window.closeModals = () => { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); };
        window.verifyAdmin = () => { if(document.getElementById('pin').value === PIN) { window.closeModals(); document.getElementById('modal-admin').style.display='flex'; } else { document.getElementById('pin').value = ""; } };
        window.doImport = async () => {
            if(!state.authed) return;
            const btn = document.getElementById('import-btn');
            try {
                const list = JSON.parse(document.getElementById('json-input').value);
                btn.innerText = "Êõ¥Êñ∞‰∏≠...";
                await window.fb.setDoc(window.fb.doc(state.db, 'artifacts', appId, 'public', 'data', 'daily_events', getJST().stamp), { list, updatedAt: Date.now() });
                btn.innerText = "ÂÆå‰∫ÜÔºÅ";
                setTimeout(() => { window.closeModals(); btn.innerText = "ÂèçÊò†"; }, 1000);
            } catch { btn.innerText = "„Ç®„É©„Éº"; setTimeout(()=>btn.innerText="ÂèçÊò†", 2000); }
        };

        init();
        setInterval(refreshUI, 1000);
    </script>
</body>
</html>

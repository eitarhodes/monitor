<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitor Master 2026 Premium V81</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --bg: #f1f5f9; --blue: #2563eb; --red: #ef4444; --purple: #a855f7; --slate: #334155; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding-bottom: 120px; color: #0f172a; overflow-x: hidden; }
        .status-bar { position: sticky; top: 0; z-index: 4000; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); display: flex; justify-content: space-between; align-items: center; padding: 8px 16px; font-size: 10px; font-weight: bold; border-bottom: 1px solid #e2e8f0; }
        .container { max-width: 600px; margin: 0 auto; padding: 8px; }
        .header { background: white; border-radius: 24px; padding: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 12px; }
        .clock { font-family: monospace; font-size: 24px; font-weight: 900; font-style: italic; letter-spacing: -1px; }
        .btn-main { background: var(--blue); color: white; border: none; border-radius: 16px; padding: 12px; font-weight: 900; font-size: 12px; width: 100%; cursor: pointer; box-shadow: 0 4px 0 #1e40af; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-main:active { transform: translateY(2px); box-shadow: 0 2px 0 #1e40af; }
        .card { background: white; border-radius: 24px; padding: 12px 16px; border: 2px solid #e2e8f0; margin-bottom: 8px; position: relative; transition: 0.2s; }
        .card.urgent { border-color: var(--red); background: #fff1f2; animation: pulse 2s infinite; }
        .card.finished { border-color: var(--purple); background: #faf5ff; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.2); } 50% { box-shadow: 0 0 15px 5px rgba(239,68,68,0.1); } }
        .flex-between { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
        .capa-badge { background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 6px; font-family: monospace; font-size: 11px; font-weight: bold; }
        .time-box { width: 105px; padding: 6px; background: #f8fafc; border-radius: 12px; text-align: left; }
        .finish-box { width: 120px; text-align: center; background: #f3e8ff; border: 1px solid #d8b4fe; border-radius: 12px; padding: 6px; }
        .large-time { font-size: 28px; font-weight: 900; font-family: monospace; color: var(--purple); line-height: 1; }
        .expand-content { max-height: 0; opacity: 0; overflow: hidden; transition: 0.2s; }
        .expand-content.open { max-height: 200px; opacity: 1; padding-top: 10px; }
        .modal { position: fixed; inset: 0; z-index: 6000; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; border-radius: 32px; padding: 32px; width: 100%; max-width: 400px; text-align: center; }
        .pass-input { width: 100%; text-align: center; font-size: 32px; letter-spacing: 10px; padding: 12px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 16px; margin-bottom: 20px; outline: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div class="status-bar">
        <div style="display:flex; align-items:center; gap:8px;">
            <span id="sync-indicator" style="color:var(--blue)">CONNECTING</span>
            <span id="data-date-label" style="opacity:0.4">DATE: ----</span>
        </div>
        <div style="display:flex; gap:12px;">
            <button onclick="manualFetch()" style="background:none; border:none; color:#94a3b8; font-weight:bold; cursor:pointer;">ğŸ”„ å–å¾—</button>
            <span style="background:var(--slate); color:white; padding:2px 6px; border-radius:10px;">V81 PRO</span>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div style="background:var(--blue); color:white; padding:8px; border-radius:14px; display:flex;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                    </div>
                    <div>
                        <div id="display-date" style="font-weight:900; font-size:14px;">----/--/--</div>
                        <div style="font-size:8px; font-weight:bold; opacity:0.3; text-transform:uppercase;">Realtime Monitor</div>
                    </div>
                </div>
                <div id="clock" class="clock">00:00:00</div>
            </div>

            <div style="display:flex; gap:8px;">
                <button id="voice-toggle" class="btn-main" onclick="toggleVoice()" style="flex:2;">ğŸ”ˆ éŸ³å£°é€šçŸ¥ã‚’é–‹å§‹</button>
                <button id="test-voice-btn" onclick="runVoiceTest()" style="display:none; flex:1; background:#f1f5f9; border:1px solid #e2e8f0; border-radius:16px; font-weight:bold; font-size:11px;">ğŸ“¢ è©¦è´</button>
            </div>
        </div>

        <div id="event-list">
            <div id="init-loader" style="padding:60px 0; text-align:center; opacity:0.2; font-weight:900; font-style:italic;">Initializing...</div>
        </div>

        <div style="margin-top:40px; display:flex; flex-direction:column; align-items:center; gap:20px;">
            <button onclick="cloudSync()" style="background:white; border:2px solid var(--blue); color:var(--blue); padding:12px 24px; border-radius:30px; font-weight:900; font-size:13px; box-shadow:0 4px 6px rgba(0,0,0,0.05);">çŠ¶æ³ã‚’å…¨å“¡ã«åŒæœŸ</button>
            <div id="sync-status" style="font-size:9px; font-weight:bold; color:var(--blue); height:10px;"></div>
            <button onclick="toggleHistoryUI()" id="history-btn" style="background:none; border:none; color:#94a3b8; text-decoration:underline; font-size:10px; font-weight:bold; letter-spacing:1px;">çµ‚äº†å±¥æ­´ã‚’è¡¨ç¤º</button>
            <div id="history-list" style="display:none; width:100%;"></div>
            
            <button onclick="requestAdminAccess()" style="margin-top:40px; opacity:0.1; background:none; border:none; font-size:8px; font-weight:bold; letter-spacing:2px;">ADMIN PANEL</button>
        </div>
    </div>

    <!-- ç®¡ç†è€…ãƒ‘ãƒãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="admin-panel-container" class="modal" onclick="if(event.target==this)this.style.display='none'">
        <div class="modal-content" style="max-width:500px; text-align:left;">
            <h3 style="margin-top:0; font-weight:900;">Admin Control</h3>
            <p style="font-size:11px; color:#64748b; margin-bottom:12px;">AIã‹ã‚‰å±Šã„ãŸJSONã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„</p>
            <textarea id="data-input" style="width:100%; font-family:monospace; font-size:10px; border-radius:16px; border:1px solid #ddd; padding:12px;" rows="8" placeholder="JSONã‚’è²¼ã‚Šä»˜ã‘"></textarea>
            <button class="btn-main" style="margin-top:12px;" onclick="importDailyEvents()">ã‚¯ãƒ©ã‚¦ãƒ‰ã¸åæ˜ </button>
            <button onclick="deleteAllEvents()" style="width:100%; margin-top:20px; background:#fff1f2; color:var(--red); border:1px solid #fecaca; padding:12px; border-radius:16px; font-weight:bold;">ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¨å‰Šé™¤</button>
        </div>
    </div>

    <!-- ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="passcode-modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0; font-weight:900;">ç®¡ç†è€…èªè¨¼</h3>
            <p style="font-size:11px; color:#64748b; margin-bottom:16px;">Admin Passcode Required</p>
            <input type="password" id="passcode-input" class="pass-input" maxlength="4" inputmode="numeric" placeholder="****">
            <div style="display:flex; gap:10px;">
                <button onclick="document.getElementById('passcode-modal').style.display='none'" style="flex:1; border:none; background:none; color:#94a3b8; font-weight:bold;">æˆ»ã‚‹</button>
                <button onclick="verifyPasscode()" style="flex:2; background:var(--blue); color:white; border:none; padding:12px; border-radius:16px; font-weight:bold;">èªè¨¼</button>
            </div>
        </div>
    </div>

    <audio id="se-chime" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
    <audio id="se-silent" src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=" loop></audio>

    <script>
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'monitor-2026-v81-core';
        const apiKey = ""; 
        const ADMIN_PASSCODE = "2026";

        let state = {
            hiddenIds: new Set(),
            restoredIds: new Set(),
            expandedIds: new Set(),
            audio: false,
            user: null,
            isAdmin: false,
            notified30: new Set(),
            notified10: new Set(),
            events: JSON.parse(localStorage.getItem('ev_cache') || '[]'),
            lastRenderMinute: -1
        };

        function getJSTDate() {
            const now = new Date();
            const jst = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (9 * 3600000));
            return jst.getFullYear() + String(jst.getMonth()+1).padStart(2,'0') + String(jst.getDate()).padStart(2,'0');
        }

        // --- Firebase Core (RULE 3) ---
        const fbConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        if (fbConfigStr) {
            firebase.initializeApp(JSON.parse(fbConfigStr));
            const db = firebase.firestore();
            const auth = firebase.auth();

            auth.onAuthStateChanged(user => {
                state.user = user;
                if (user) {
                    document.getElementById('sync-indicator').innerText = "ONLINE";
                    startSync(db);
                } else {
                    document.getElementById('sync-indicator').innerText = "OFFLINE";
                }
            });

            (async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await auth.signInWithCustomToken(__initial_auth_token);
                    else await auth.signInAnonymously();
                } catch (e) { document.getElementById('sync-indicator').innerText = "AUTH ERR"; }
            })();
        }

        function startSync(db) {
            if (!state.user) return;
            const today = getJSTDate();
            document.getElementById('data-date-label').innerText = `DATE: ${today}`;
            
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection(today).doc('shared')
            .onSnapshot(s => {
                if (s.exists) {
                    const d = s.data();
                    state.hiddenIds = new Set(d.hiddenIds || []);
                    state.restoredIds = new Set(d.restoredIds || []);
                    refresh(true);
                }
            });

            db.collection('artifacts').doc(appId).collection('public').doc('data').collection(today).doc('event_list')
            .onSnapshot(s => {
                state.events = s.exists ? s.data().list || [] : [];
                localStorage.setItem('ev_cache', JSON.stringify(state.events));
                refresh(true);
            });
        }

        // --- UI Logic ---
        function requestAdminAccess() {
            if (state.isAdmin) { document.getElementById('admin-panel-container').style.display = 'flex'; return; }
            document.getElementById('passcode-modal').style.display = 'flex';
        }
        function verifyPasscode() {
            if (document.getElementById('passcode-input').value === ADMIN_PASSCODE) {
                state.isAdmin = true; document.getElementById('passcode-modal').style.display = 'none'; document.getElementById('admin-panel-container').style.display = 'flex';
            } else { document.getElementById('passcode-input').value = ""; }
        }
        async function importDailyEvents() {
            if(!state.user || !state.isAdmin) return;
            const raw = document.getElementById('data-input').value;
            try {
                const list = JSON.parse(raw);
                await firebase.firestore().collection('artifacts').doc(appId).collection('public').doc('data').collection(getJSTDate()).doc('event_list').set({ list, updatedAt: Date.now() });
                document.getElementById('admin-panel-container').style.display = 'none';
            } catch(e) { alert("JSONå½¢å¼ã‚¨ãƒ©ãƒ¼"); }
        }
        async function deleteAllEvents() {
            if(!state.user || !state.isAdmin) return;
            await firebase.firestore().collection('artifacts').doc(appId).collection('public').doc('data').collection(getJSTDate()).doc('event_list').set({ list: [] });
            document.getElementById('admin-panel-container').style.display = 'none';
        }
        async function cloudSync() {
            if(!state.user) return;
            const log = document.getElementById('sync-status');
            log.innerText = "SYNCING...";
            try {
                await firebase.firestore().collection('artifacts').doc(appId).collection('public').doc('data').collection(getJSTDate()).doc('shared').set({
                    hiddenIds: Array.from(state.hiddenIds), restoredIds: Array.from(state.restoredIds), ts: Date.now()
                });
                log.innerText = "SUCCESS"; setTimeout(() => log.innerText = "", 2000);
            } catch(e) { log.innerText = "FAIL"; }
        }

        // --- Audio & TTS ---
        async function speak(text) {
            if(!state.audio) return;
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `è½ã¡ç€ã„ãŸãƒ—ãƒ­ã®ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ï¼š${text}` }] }],
                        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } }
                    })
                });
                const res = await r.json();
                const pcm = res.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if(pcm) {
                    const b = atob(pcm), len = b.length, buf = new ArrayBuffer(44 + len), v = new DataView(buf);
                    const s = (o, s) => { for (let i = 0; i < s.length; i++) v.setUint8(o + i, s.charCodeAt(i)) };
                    s(0, 'RIFF'); v.setUint32(4, 36 + len, true); s(8, 'WAVE'); s(12, 'fmt ');
                    v.setUint32(16, 16, true); v.setUint16(20, 1, true); v.setUint16(22, 1, true); v.setUint32(24, 24000, true);
                    v.setUint32(28, 48000, true); v.setUint16(32, 2, true); v.setUint16(34, 16, true); s(36, 'data'); v.setUint32(40, len, true);
                    for (let i = 0; i < len; i++) v.setUint8(44 + i, b.charCodeAt(i));
                    new Audio(URL.createObjectURL(new Blob([buf], { type: 'audio/wav' }))).play();
                }
            } catch(e) {}
        }

        function triggerAlert(names, min) {
            if(!state.audio) return;
            document.getElementById('se-chime').play().catch(()=>{});
            speak(`${names.map(n => n.split('@')[0].replace(/[ğŸ¨ğŸ“ãƒ›ãƒ†ãƒ«ã‚¶ãƒ»æ±äº¬]/g, '')).join('ã€')}ã€${min}åˆ†å‰ã§ã™ã€‚`);
        }

        // --- Render ---
        function refresh(force = false) {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            if (!force && now.getMinutes() === state.lastRenderMinute) return;
            state.lastRenderMinute = now.getMinutes();

            const today = getJSTDate();
            document.getElementById('display-date').innerText = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')}`;

            const prc = (state.events || []).filter(e => e.date === today).map(e => {
                const [h, m] = e.end.split(':').map(Number);
                const target = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0);
                return { ...e, diffMin: Math.floor((target - now) / 60000) };
            });

            if(state.audio) {
                const t30 = prc.filter(e => e.diffMin === 30 && !state.notified30.has(e.id));
                if(t30.length) { triggerAlert(t30.map(e => e.location), 30); t30.forEach(e => state.notified30.add(e.id)); }
                const t10 = prc.filter(e => e.diffMin === 10 && !state.notified10.has(e.id));
                if(t10.length) { triggerAlert(t10.map(e => e.location), 10); t10.forEach(e => state.notified10.add(e.id)); }
            }

            const main = prc.filter(e => state.restoredIds.has(e.id) || (!state.hiddenIds.has(e.id) && e.diffMin > -66)).sort((a,b) => a.diffMin - b.diffMin);
            const listEl = document.getElementById('event-list');
            if (!main.length) { listEl.innerHTML = `<div style="padding:80px 0; text-align:center; opacity:0.3; font-weight:900; font-size:12px;">NO EVENTS TODAY</div>`; return; }

            listEl.innerHTML = main.map((e, idx) => {
                const isF = e.diffMin <= 0, st = isF ? "finished" : e.diffMin <= 10 ? "urgent" : e.diffMin <= 30 ? "alert" : "normal";
                const prog = isF ? Math.min(100, (Math.abs(e.diffMin) / 65) * 100) : Math.max(0, 100 - (e.diffMin / 60) * 100);
                return `
                <div class="card ${st==='urgent'?'urgent':''} ${isF?'finished':''}">
                    <button onclick="state.hiddenIds.add(${e.id});cloudSync();" style="position:absolute; top:8px; right:12px; background:none; border:none; opacity:0.2; font-weight:900; cursor:pointer;">âœ•</button>
                    <div class="flex-between">
                        <div style="flex:1; min-width:0;">
                            <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
                                <span style="font-size:10px; font-weight:900; opacity:0.2;">${idx+1}</span>
                                <div onclick="window.open('https://google.com/maps/search/?api=1&query=${encodeURIComponent(e.location)}','_blank')" style="font-size:18px; font-weight:900; text-decoration:underline; color:${st==='urgent'?'var(--red)':st==='finished'?'var(--purple)':'var(--blue)'}; cursor:pointer;" class="truncate text-left">ğŸ“${e.location.split('@')[0].replace(/[ğŸ¨ğŸ“]/g,'')}</div>
                            </div>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span class="capa-badge">CAPA ${e.capa}</span>
                                <span style="font-size:9px; opacity:0.3; font-weight:bold;">@${e.location.split('@')[1]||''}</span>
                            </div>
                        </div>
                        <div style="flex-shrink:0;">
                            ${!isF ? `<div class="time-box" style="border:2px solid ${st==='urgent'?'var(--red)':st==='alert'?'#facc15':'#e2e8f0'}">
                                <span style="font-size:8px; f
                                
